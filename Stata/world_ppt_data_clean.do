/**********************************************************This .do file reads in the following .csv files from Ankit,which are used in our WORLD POWERPOINT analyses:It also reads in the country-level data from various sourceswhich are also used in our WORLD POWERPOINT analyses.It also reads in the older DB data (without detailed countryand industry breakdowns)It then collapses this data so there isone observation for each tenantID-country pairing.All of these are merged together.**********************************************************/set more offcapture log closeclearlog using "logs/world_ppt_data_clean_$S_DATE", replacecd ..insheet using "data/raw/MS/utilization_06.13.csv", names casecd Statasave "data/utilization_world", replaceclearcd ..insheet using "data/raw/MS/cultureofwork_06.13.csv", names caseforeach var in msgSenders msgSentPerUser msgSentLowerQtileVal msgSentUpperQtileVal mtgAttendees mtgHoursPerAttendee mtgHoursLowerQtileVal mtgHoursUpperQtileVal {replace `var'="" if `var'=="#NUL#"destring `var', replace}cd Statasave "data/cultureofwork_world", replaceclearcd ..insheet using "data/raw/MS/networksize_06.20.csv"cd Statasave "data/networksize_world", replaceclearuse "data/utilization_world"g NumberOfWeeks=1label var NumberOfWeeks "Number of Weeks of Data"collapse (mean) MeanUtilizationHours MeanAfterHoursWork UserCount TotalHumanMailboxes (sum) NumberOfWeeks, by ( OmsTenantId IndustryGroup Country TenantSize)save "data/MS_collapse_by_tenant_world", replaceclearuse "data/cultureofwork_world"g NumberOfWeeks=1label var NumberOfWeeks "Number of Weeks of Data"collapse (mean) msgSentPerUser mtgHoursPerAttendee msgSentLowerQtileVal msgSentUpperQtileVal mtgHoursLowerQtileVal mtgHoursUpperQtileVal  mtgAttendees msgSenders TotalHuman (sum) NumberOfWeeks, by (OmsTenant)rename NumberOfWeeks NumberOfWeeks_culturerename TotalHuman TotalHumanMailboxes_culturejoinby OmsTenantId using "data/MS_collapse_by_tenant_world", unmatched(both)tab _mergedrop _mergesave "data/MS_collapse_by_tenant_world", replaceclearuse "data/networksize_world"g NumberOfWeeks_network=1collapse (mean) internalnetworksize externalnetworksize  usrcount totalhumanmailboxes (sum)  NumberOfWeeks_network, by (omstenantid)rename omstenantid OmsTenantIdjoinby OmsTenantId using "data/MS_collapse_by_tenant_world", unmatched(both)tab _mergedrop _mergesave "data/MS_collapse_by_tenant_world", replaceclearuse "data/MS_collapse_by_tenant_world"drop NumberOfWeeks_network NumberOfWeeks_culture TotalHumanMailboxes_culture usrcountorder OmsTenantId IndustryGroup Country TenantSize NumberOfWeeks UserCount TotalHumanMailboxesdrop totalhumanmailboxessave "data/MS_collapse_by_tenant_world", replaceclearcd ..insheet using "data/raw/world/world_data.csv", namesrename country Countrycd Statasave "data/world_data.dta", replacejoinby Country using "data/MS_collapse_by_tenant_world", unmatched(both)tab _mergekeep if _m==3drop _mergesave "data/MS_collapse_by_tenant_world2", replaceclear*/cd ..insheet using "data/raw/MS/tenantmetadata_09_14.csv", names caseforeach var in YEARSTARTED GRWPCT {replace `var'="" if `var'=="NULL"destring `var', replace}foreach var in GRWSIGN GRWTYPE {replace `var'="" if `var'=="NULL"}drop if Oms==""drop POSTALCD GRWPCT GRWSIGN GRWTYPE CITYduplicates drop/*for now, do max revenue only.*/bysort Oms: egen maxrevenue=max(REV)/*i decided summing was better*/bysort Oms: egen sumrevenue=sum(REV)/*For now, do ealiest year founded*/bysort Oms: egen earlyyear=min(YEAR)/*For now, do max of employees. Sum?*/bysort Oms: egen maxemploy=max(EMP)/*i decided summing was better*/bysort Oms: egen sumemploy=sum(EMP)drop REVENUEdrop YEARdrop EMP/*replace COUNTRY="United Kingdom" if COUNTRY=="ENGLAND"replace COUNTRY="United Kingdom" if COUNTRY=="NORTHERN IRELAND"replace COUNTRY="United Kingdom" if COUNTRY=="SCOTLAND"replace COUNTRY="United Kingdom" if COUNTRY=="WALES"replace COUNTRY="United States" if COUNTRY=="USA"replace COUNTRY=proper(COUNTRY)*/*bysort Oms COUNTRY LINE: egen minyear=min(YEAR)duplicates drop*bysort Oms COUNTRY YEAR: g counter=_nbysort Oms : g counter=_nsum counter, detailbysort Oms: egen max=max(counter)sum max, detaildrop LINEdrop counterduplicates dropbysort Oms : g counter=_nsum counter, detaildrop maxreshape wide COUN, i(Oms max* sum*) j(counter)cd Statasave "data\tenant_metadata_ppt", replacejoinby Oms using "data/MS_collapse_by_tenant_world2", unmatched(both)save "data/MS_collapse_by_tenant_world_db", replaceclear